<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Barber Shop Booking</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="styles.css" rel="stylesheet">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Book Your Barber Appointment</h1>
      <p>Follow the steps below to book your appointment</p>
    </div>
    
    <div class="progress-bar">
      <div class="progress-step active" data-step="1">
        <div class="step-circle">1</div>
        <div class="step-label">Select Barber</div>
      </div>
      <div class="progress-step" data-step="2">
        <div class="step-circle">2</div>
        <div class="step-label">Choose Service</div>
      </div>
      <div class="progress-step" data-step="3">
        <div class="step-circle">3</div>
        <div class="step-label">Pick Date & Time</div>
      </div>
      <div class="progress-step" data-step="4">
        <div class="step-circle">4</div>
        <div class="step-label">Your Details</div>
      </div>
    </div>
    
    <form id="bookingForm">
      <!-- Step 1: Select Barber -->
      <div class="form-section active" data-step="1">
        <div class="step-instruction">
          <strong>Step 1:</strong> Please select your preferred barber to proceed.
        </div>
        <div class="form-group">
          <label for="barber">Select Barber:</label>
          <select id="barber" name="barber" required>
            <option value="">Loading barbers...</option>
          </select>
          <div class="helper-text">Choose your preferred barber to see their available services and times.</div>
        </div>
        <div class="navigation-buttons">
          <button type="button" class="btn-prev hidden">Previous</button>
          <button type="button" class="btn-next" data-next="2">Next Step</button>
        </div>
      </div>
      
      <!-- Step 2: Choose Service -->
      <div class="form-section" data-step="2">
        <div class="step-instruction">
          <strong>Step 2:</strong> Select the service you'd like to book.
        </div>
        <div class="form-group">
          <div class="service-options">
            <label class="service-option" for="service-haircut">
              <input type="radio" id="service-haircut" name="service" value="Haircut">
              <div class="service-info">
                <div class="service-name">Haircut</div>
                <div class="service-details">45 min</div>
              </div>
              <div class="service-price">$45.00</div>
            </label>
            
            <label class="service-option" for="service-haircut-beard">
              <input type="radio" id="service-haircut-beard" name="service" value="Haircut & Beard Trim">
              <div class="service-info">
                <div class="service-name">Haircut & Beard Trim</div>
                <div class="service-details">60 min</div>
              </div>
              <div class="service-price">$60.00</div>
            </label>
            
            <label class="service-option" for="service-haircut-beard-shave">
              <input type="radio" id="service-haircut-beard-shave" name="service" value="Haircut, Beard Trim & Straight Razor Shave">
              <div class="service-info">
                <div class="service-name">Haircut, Beard Trim & Straight Razor Shave</div>
                <div class="service-details">60 min</div>
              </div>
              <div class="service-price">$80.00</div>
            </label>
            
            <label class="service-option" for="service-razor-shave">
              <input type="radio" id="service-razor-shave" name="service" value="Straight Razor Shave">
              <div class="service-info">
                <div class="service-name">Straight Razor Shave</div>
                <div class="service-details">30 min</div>
              </div>
              <div class="service-price">$35.00</div>
            </label>
            
            <label class="service-option" for="service-beard-trim">
              <input type="radio" id="service-beard-trim" name="service" value="Beard Trim">
              <div class="service-info">
                <div class="service-name">Beard Trim</div>
                <div class="service-details">30 min</div>
              </div>
              <div class="service-price">$30.00</div>
            </label>
            
            <label class="service-option" for="service-enhancement-perm">
              <input type="radio" id="service-enhancement-perm" name="service" value="Hair Enhancement (Permanent)">
              <div class="service-info">
                <div class="service-name">Hair Enhancement (Permanent)</div>
                <div class="service-details">45 min</div>
              </div>
              <div class="service-price">$45.00</div>
            </label>
            
            <label class="service-option" for="service-enhancement-temp">
              <input type="radio" id="service-enhancement-temp" name="service" value="Hair Enhancement (Temporary - Air-Brush)">
              <div class="service-info">
                <div class="service-name">Hair Enhancement (Temporary - Air-Brush)</div>
                <div class="service-details">15 min</div>
              </div>
              <div class="service-price">$15.00</div>
            </label>
          </div>
        </div>
        <div class="navigation-buttons">
          <button type="button" class="btn-prev" data-prev="1">Previous</button>
          <button type="button" class="btn-next" data-next="3">Next Step</button>
        </div>
      </div>
      
      <!-- Step 3: Pick Date & Time -->
      <div class="form-section" data-step="3">
        <div class="step-instruction">
          <strong>Step 3:</strong> Choose your preferred date and available time slot.
        </div>
        <div class="form-group">
          <label for="date">Select Date:</label>
          <select id="date" name="date" required>
            <option value="">Select a date</option>
          </select>
          <div class="helper-text">Pick a date to see available time slots.</div>
        </div>
        <div class="form-group">
          <label for="time">Select Time:</label>
          <select id="time" name="time" required>
            <option value="">Select a date first</option>
          </select>
          <div class="helper-text">Choose from available time slots for your selected date.</div>
        </div>
        <div class="navigation-buttons">
          <button type="button" class="btn-prev" data-prev="2">Previous</button>
          <button type="button" class="btn-next" data-next="4">Next Step</button>
        </div>
      </div>
      
      <!-- Step 4: Your Details -->
      <div class="form-section" data-step="4">
        <div class="step-instruction">
          <strong>Final Step:</strong> Please provide your contact information.
        </div>
        <div class="form-group">
          <label for="name">Full Name:</label>
          <input type="text" id="name" name="name" required>
          <div class="helper-text">Enter your full name as it should appear on the booking.</div>
        </div>
        <div class="form-group">
          <label for="phone">Phone Number:</label>
          <input type="tel" id="phone" name="phone">
          <div class="helper-text">We'll send booking confirmations to this number.</div>
        </div>
        <div class="form-group">
          <label for="email">Email Address:</label>
          <input type="email" id="email" name="email">
          <div class="helper-text">We'll send booking confirmations to this email.</div>
        </div>
        <div class="navigation-buttons">
          <button type="button" class="btn-prev" data-prev="3">Previous</button>
          <button type="submit" class="btn-submit">Confirm Booking</button>
        </div>
      </div>
    </form>
    
    <div id="message" class="hidden"></div>
  </div>
  
  <script>
    // API base URL - update with your server address
    const API_BASE_URL = '/.netlify/functions/api';
    
    // DOM elements
    const barberSelect = document.getElementById('barber');
    const dateSelect = document.getElementById('date');
    const timeSelect = document.getElementById('time');
    const bookingForm = document.getElementById('bookingForm');
    const messageDiv = document.getElementById('message');
    const serviceOptions = document.querySelectorAll('.service-option');
    
    // Service selection handling
    serviceOptions.forEach(option => {
      option.addEventListener('click', function() {
        // Remove selected class from all options
        serviceOptions.forEach(opt => opt.classList.remove('selected'));
        // Add selected class to clicked option
        this.classList.add('selected');
        // Check the radio button
        const radio = this.querySelector('input[type="radio"]');
        radio.checked = true;
      });
    });
    
    // Load barbers when page loads
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const response = await fetch(`${API_BASE_URL}/available-barbers`, {
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
        });
        if (!response.ok) throw new Error('Failed to fetch barbers');
        
        const data = await response.json();
        
        // Clear loading option
        barberSelect.innerHTML = '<option value="">Select a barber</option>';
        
        // Add barber options
        data.barbers.forEach(barber => {
          const option = document.createElement('option');
          option.value = barber;
          option.textContent = barber;
          barberSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading barbers:', error);
        showMessage('Error loading barbers. Please refresh the page.', 'error');
      }
    });
    
    // Load available dates when barber is selected
    barberSelect.addEventListener('change', async () => {
      const selectedBarber = barberSelect.value;
      
      // Reset date and time select
      dateSelect.innerHTML = '<option value="">Loading dates...</option>';
      timeSelect.innerHTML = '<option value="">Select a date first</option>';
      
      if (!selectedBarber) {
        dateSelect.innerHTML = '<option value="">Select a barber first</option>';
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/available-dates/${selectedBarber}`, {
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
        });
        if (!response.ok) throw new Error('Failed to fetch dates');
        
        const data = await response.json();
        
        // Clear loading option
        dateSelect.innerHTML = '<option value="">Select a date</option>';
        
        // Add date options
        data.dates.forEach(date => {
          const option = document.createElement('option');
          option.value = date;
          option.textContent = formatDate(date);
          dateSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading dates:', error);
        dateSelect.innerHTML = '<option value="">Error loading dates</option>';
      }
    });
    
    // Load available times when date is selected
    dateSelect.addEventListener('change', async () => {
      const selectedDate = dateSelect.value;
      const selectedBarber = barberSelect.value;
      
      // Reset time select
      timeSelect.innerHTML = '<option value="">Loading times...</option>';
      
      if (!selectedDate) {
        timeSelect.innerHTML = '<option value="">Select a date first</option>';
        return;
      }
      
      try {
        // Ensure the date is properly encoded for the URL
        const encodedDate = encodeURIComponent(selectedDate);
        
        const url = selectedBarber
          ? `${API_BASE_URL}/available-times/${encodedDate}/${selectedBarber}`
          : `${API_BASE_URL}/available-times/${encodedDate}`;
          
        const response = await fetch(url, {
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
        });
        if (!response.ok) throw new Error('Failed to fetch times');
        
        const data = await response.json();
        
        // Clear loading option
        timeSelect.innerHTML = '<option value="">Select a time</option>';
        
        // Add time options
        data.availableTimes.forEach(timeSlot => {
          const option = document.createElement('option');
          option.value = timeSlot.time;
          option.textContent = `${timeSlot.time} - ${timeSlot.barber}`;
          timeSelect.appendChild(option);
        });
        
        if (data.availableTimes.length === 0) {
          timeSelect.innerHTML = '<option value="">No available times</option>';
        }
      } catch (error) {
        console.error('Error loading times:', error);
        timeSelect.innerHTML = '<option value="">Error loading times</option>';
      }
    });
    
    // Form submission
    bookingForm.addEventListener('submit', async event => {
      event.preventDefault();
      
      if (!validateStep(1) || !validateStep(2) || !validateStep(3)) {
        return;
      }
      
      // Get selected service
      const selectedServiceInput = document.querySelector('input[name="service"]:checked');
      if (!selectedServiceInput) {
        showMessage('Please select a service.', 'error');
        return;
      }
      
      const formData = {
        barber: barberSelect.value,
        service: selectedServiceInput.value,
        date: dateSelect.value,
        time: timeSelect.value,
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value
      };
      
      // Validate form data
      if (!formData.barber || !formData.service || !formData.date || !formData.time || !formData.name) {
        showMessage('Please fill out all required fields.', 'error');
        return;
      }
      
      try {
        // Submit the booking to our API
        const response = await fetch(`${API_BASE_URL}/submit-booking`, {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          // Show success message
          showMessage(`Appointment booked successfully! ${formData.email ? 'A confirmation email will be sent shortly.' : ''}`, 'success');
          
          // Reset the form
          bookingForm.reset();
          serviceOptions.forEach(opt => opt.classList.remove('selected'));
          dateSelect.innerHTML = '<option value="">Select a barber first</option>';
          timeSelect.innerHTML = '<option value="">Select a date first</option>';
        } else {
          showMessage(`Booking failed: ${result.error || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        console.error('Error submitting booking:', error);
        showMessage('There was a problem submitting your booking. Please try again later.', 'error');
      }
    });
    
    // Helper function to format date
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }
    
    // Helper function to show messages
    function showMessage(text, type) {
      messageDiv.textContent = text;
      messageDiv.className = type;
      messageDiv.style.display = 'block';
      
      // Scroll to the message
      messageDiv.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Add after the existing event listeners
    function updateProgressBar(currentStep) {
      document.querySelectorAll('.progress-step').forEach(step => {
        const stepNum = parseInt(step.dataset.step);
        step.classList.remove('active', 'completed');
        if (stepNum < currentStep) {
          step.classList.add('completed');
        } else if (stepNum === currentStep) {
          step.classList.add('active');
        }
      });
    }

    function showStep(stepNumber) {
      document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
      });
      document.querySelector(`.form-section[data-step="${stepNumber}"]`).classList.add('active');
      updateProgressBar(stepNumber);
    }

    // Add navigation button event listeners
    document.querySelectorAll('.btn-next').forEach(button => {
      button.addEventListener('click', function() {
        const currentStep = parseInt(this.closest('.form-section').dataset.step);
        const nextStep = parseInt(this.dataset.next);
        
        // Validate current step before proceeding
        if (validateStep(currentStep)) {
          showStep(nextStep);
        }
      });
    });

    document.querySelectorAll('.btn-prev').forEach(button => {
      button.addEventListener('click', function() {
        const prevStep = parseInt(this.dataset.prev);
        showStep(prevStep);
      });
    });

    function validateStep(step) {
      switch(step) {
        case 1:
          if (!barberSelect.value) {
            showMessage('Please select a barber to continue.', 'error');
            return false;
          }
          return true;
        case 2:
          const selectedService = document.querySelector('input[name="service"]:checked');
          if (!selectedService) {
            showMessage('Please select a service to continue.', 'error');
            return false;
          }
          return true;
        case 3:
          if (!dateSelect.value || !timeSelect.value) {
            showMessage('Please select both date and time to continue.', 'error');
            return false;
          }
          return true;
        default:
          return true;
      }
    }
  </script>
</body>
</html> 